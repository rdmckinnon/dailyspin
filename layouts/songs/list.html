{{ define "main" }}
<section class="ds-wrap ds-section px-4">
  <header class="ds-hero-slim text-center mb-5 pt-5">
    <h1 class="mb-3" style="font-size: 4rem;">THE ARCHIVE</h1>
    <p class="text-muted text-uppercase fw-bold">Explore the collection</p>
  </header>

  {{ $total := len .Pages }}
  <div class="ds-controls justify-content-center mb-5" role="region" aria-label="Song filters">
    <label class="ds-input" aria-label="Filter songs">
      <svg class="ds-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input id="q" type="search" placeholder="Search..." autocomplete="off" />
    </label>
    <div class="ds-select">
      <select id="sort" aria-label="Sort songs"
        style="background: transparent; border: 1px solid var(--ds-border); color: var(--ds-fg); outline: none; padding: 1rem; font-family: var(--ds-font-body); text-transform: uppercase; height: 100%; border-radius: 100px;">
        <option value="new" style="background: var(--ds-bg);">Newest</option>
        <option value="old" style="background: var(--ds-bg);">Oldest</option>
        <option value="az" style="background: var(--ds-bg);">A–Z</option>
        <option value="za" style="background: var(--ds-bg);">Z–A</option>
      </select>
    </div>
  </div>

  {{ $pages := .Pages }}
  <ul id="grid" class="ds-grid" role="list">
    {{ range $index, $page := $pages }}
    {{ with $page }}
    {{ $title := .Title }}
    {{ $artists := delimit (.Params.artists) ", " }}
    {{ $genres := delimit (.Params.genres) ", " }}
    {{ $tags := delimit (.Params.tags) ", " }}
    {{ $year := .Params.release_year }}
    <li class="ds-card" role="listitem" data-title="{{ $title | lower }}" data-artists="{{ $artists | lower }}"
      data-genres="{{ $genres | lower }}" data-tags="{{ $tags | lower }}" data-year="{{ $year }}">
      <a class="ds-card-link" href="{{ .RelPermalink }}" aria-label="Open {{ .Title }}">
        <div class="ds-art">
          {{ $imgNum := add (mod $index 3) 1 }}
          <img src="/images/placeholders/art-{{ $imgNum }}.png" alt="Abstract Studio Art"
            style="width:100%; height:100%; object-fit: cover; opacity: 0.8;">
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="ds-card-meta mb-0">{{ .Date | time.Format "01.02" }}</span>
          <span class="ds-card-meta mb-0">{{ with .Params.artists }}{{ delimit . ", " }}{{ end }}</span>
        </div>

        <h3 class="ds-card-title" style="font-size: 1.75rem;">{{ .Title }}</h3>
        <div class="ds-card-summary">{{ .Summary | truncate 100 }}</div>
      </a>
    </li>
    {{ end }}
    {{ end }}
  </ul>

  <p id="empty" class="ds-empty py-5">NO SONGS FOUND.</p>
</section>

<script>
  (function () {
    const q = document.getElementById('q');
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const sortSel = document.getElementById('sort');
    if (!q || !grid) return;

    let items = Array.from(grid.children);

    function matches(li, term) {
      if (!term) return true;
      term = term.toLowerCase();
      return (
        li.dataset.title.includes(term) ||
        li.dataset.artists.includes(term) ||
        li.dataset.genres.includes(term) ||
        li.dataset.tags.includes(term) ||
        (li.dataset.year || '').includes(term)
      );
    }

    function applyFilterAndSort() {
      const term = (q.value || '').trim().toLowerCase();
      let visible = 0;
      items.forEach(li => {
        const ok = matches(li, term);
        li.style.display = ok ? '' : 'none';
        if (ok) visible++;
      });
      empty.style.display = visible ? 'none' : 'block';

      // Sort only visible items
      const mode = sortSel.value;
      const visibleItems = items.filter(li => li.style.display !== 'none');
      visibleItems.sort((a, b) => {
        if (mode === 'az' || mode === 'za') {
          const at = a.dataset.title, bt = b.dataset.title;
          const cmp = at.localeCompare(bt);
          return mode === 'az' ? cmp : -cmp;
        }
        // year sort fallback
        const ay = parseInt(a.dataset.year || '0', 10);
        const by = parseInt(b.dataset.year || '0', 10);
        return mode === 'old' ? (ay - by) : (by - ay); // default newest
      });
      // Re-append in order
      visibleItems.forEach(el => grid.appendChild(el));
    }

    q.addEventListener('input', applyFilterAndSort);
    q.addEventListener('keydown', (e) => { if (e.key === 'Escape') { q.value = ''; applyFilterAndSort(); q.blur(); } });
    sortSel.addEventListener('change', applyFilterAndSort);
  })();
</script>
{{ end }}
